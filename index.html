<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Espetinho Sousa</title>
  <style>
    :root{
      --bg0:#070707;
      --bg1:#0b0b0b;
      --card: rgba(18,18,18,.78);
      --stroke: rgba(255,255,255,.10);
      --text:#f4f4f4;
      --muted:#bdbdbd;
      --accent:#ffb100;
      --accent2:#ff7a00;
      --ok:#31d07a;
      --danger:#ff6a6a;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --r1:18px;
      --r2:26px;
      --max:980px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 450px at 20% 0%, rgba(255,177,0,.20), transparent 60%),
        radial-gradient(800px 380px at 100% 10%, rgba(255,122,0,.16), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }
    a{ color:inherit; text-decoration:none; }
    .wrap{ max-width:var(--max); margin:0 auto; padding:16px 14px 110px; }

    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:14px;
      padding:14px 14px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(18,18,18,.88), rgba(10,10,10,.72));
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      position:sticky; top:10px; z-index:10;
      backdrop-filter: blur(10px);
    }
    .brand{ display:flex; align-items:center; gap:12px; min-width:0; }
    .logo{
      width:46px; height:46px; border-radius:16px; overflow:hidden;
      background: radial-gradient(circle at 30% 30%, #ffd36a, #ffb100 55%, #b43a00 100%);
      box-shadow: 0 10px 30px rgba(255,140,0,.25);
      flex:0 0 auto;
      display:grid; place-items:center;
    }
    .logo img{ width:100%; height:100%; object-fit:cover; display:block; }
    .title{ min-width:0; }
    .title h1{ margin:0; font-size:18px; line-height:1.1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .title p{ margin:2px 0 0; color:var(--muted); font-size:12.5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .btn{
      border:none; border-radius:999px;
      padding:12px 14px;
      font-weight:900;
      cursor:pointer;
      color:#111;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      box-shadow: 0 16px 40px rgba(255,140,0,.25);
      user-select:none;
      white-space:nowrap;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.ghost{
      background: rgba(255,255,255,.06);
      color:var(--text);
      border:1px solid var(--stroke);
      box-shadow:none;
      font-weight:800;
    }
    .btn:disabled{
      opacity:.45;
      cursor:not-allowed;
      transform:none;
      box-shadow:none;
      filter: grayscale(.4);
    }

    .hero{ margin-top:14px; padding:18px 12px 8px; text-align:center; }
    .hero h2{ margin:16px 0 10px; font-size:34px; letter-spacing:-.6px; }
    .hero p{ margin:0; color:var(--muted); font-size:16px; line-height:1.45; }

    .hoursWrap{
      margin:12px auto 0;
      max-width:780px;
      border:1px solid var(--stroke);
      background: rgba(18,18,18,.55);
      border-radius: var(--r1);
      padding:12px 12px;
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
      text-align:left;
    }
    .hoursTop{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color:var(--muted);
      font-size:12.5px;
      font-weight:700;
    }
    .badge b{ color:var(--text); }
    .statusDot{
      width:10px; height:10px; border-radius:50%;
      background: var(--ok);
      box-shadow: 0 0 0 3px rgba(49,208,122,.15);
    }
    .hoursList{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr;
      gap:6px;
      color:var(--muted);
      font-size:13.5px;
    }
    .hoursList span{ color:var(--text); font-weight:800; }
    .noteWarn{
      margin-top:10px;
      font-size:12.5px;
      color:var(--muted);
      border-top:1px dashed rgba(255,255,255,.12);
      padding-top:10px;
      line-height:1.35;
    }
    .noteWarn b{ color:var(--text); }

    section{ margin-top:22px; }
    .secTitle{ margin:0; font-size:34px; letter-spacing:-.6px; }
    .secSub{ margin:6px 0 0; color:var(--muted); font-size:15px; }

    .grid{ margin-top:14px; display:grid; grid-template-columns: 1fr; gap:14px; }
    .card{
      border:1px solid var(--stroke);
      background: rgba(18,18,18,.62);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      padding:16px 16px;
    }
    .rowTop{ display:flex; justify-content:space-between; align-items:flex-start; gap:12px; }
    .itemName{ margin:0; font-size:20px; font-weight:900; }
    .itemDesc{ margin:6px 0 0; color:var(--muted); font-size:14px; line-height:1.35; }
    .price{ font-size:20px; font-weight:900; color: var(--accent); white-space:nowrap; }

    .qtyRow{
      margin-top:14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-top: 1px solid rgba(255,255,255,.10);
      padding-top:14px;
    }
    .qtyCtrl{
      display:flex; align-items:center; gap:10px;
      background: rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 999px;
      padding:10px 10px;
      min-width: 190px;
      justify-content:space-between;
    }
    .qbtn{
      width:42px; height:42px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-size:20px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .qbtn:active{ transform: translateY(1px); }
    .qval{
      font-size:18px;
      font-weight:900;
      min-width: 34px;
      text-align:center;
    }
    .miniTotal{
      color:var(--muted);
      font-size:13px;
      text-align:right;
      line-height:1.2;
    }
    .miniTotal b{ color:var(--text); }

    .checkout{
      margin-top:18px;
      border:1px solid var(--stroke);
      background: rgba(18,18,18,.62);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      padding:16px 16px;
    }
    .fieldGrid{ display:grid; grid-template-columns: 1fr; gap:12px; margin-top:10px; }
    label{ display:block; font-size:12.5px; color:var(--muted); font-weight:800; margin-bottom:6px; }
    input, select, textarea{
      width:100%;
      padding:14px 14px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.28);
      color: var(--text);
      outline:none;
      font-size:15px;
    }
    textarea{ min-height: 90px; resize: vertical; }
    .split2{ display:grid; grid-template-columns: 1fr; gap:12px; }

    .payWrap{
      margin-top:12px;
      border-top:1px dashed rgba(255,255,255,.12);
      padding-top:12px;
    }
    .cards{
      display:flex; flex-wrap:wrap; gap:10px; margin-top:8px;
    }
    .cardPill{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      font-weight:900;
      font-size:13px;
      letter-spacing:.4px;
    }

    /* Mostra frete/total e “Delivery” só depois do CEP válido */
    .deliveryBox{
      margin-top:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      border-radius: 18px;
      padding:12px 12px;
      display:none;
    }
    .deliveryBox.show{ display:block; }

    .totals{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .pill{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      border-radius: 18px;
      padding:12px 12px;
      text-align:center;
    }
    .pill small{ display:block; color:var(--muted); font-size:12px; font-weight:800; }
    .pill b{ display:block; margin-top:4px; font-size:20px; color: var(--accent); }
    .pill.total{ grid-column: 1 / -1; }

    .actions{
      margin-top:14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    .commentBox{
      margin-top:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      border-radius: 18px;
      padding:14px 14px;
    }
    .commentsList{ margin-top:10px; display:grid; gap:10px; }
    .commentItem{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      border-radius: 16px;
      padding:12px 12px;
    }
    .commentItem .top{
      display:flex; justify-content:space-between; gap:10px; align-items:center;
      color:var(--muted); font-size:12.5px;
    }
    .stars{ color: var(--accent); font-weight:900; }
    .commentItem p{ margin:8px 0 0; color:var(--text); line-height:1.35; }

    footer{
      margin-top:26px;
      border:1px solid var(--stroke);
      background: rgba(18,18,18,.55);
      border-radius: var(--r2);
      padding:14px 14px;
      color: var(--muted);
      box-shadow: var(--shadow);
    }
    .footRow{ display:flex; gap:12px; justify-content:space-between; align-items:center; flex-wrap:wrap; }
    .footLinks{ display:flex; gap:10px; flex-wrap:wrap; }
    .footBtn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight:900;
      font-size:13px;
    }

    .floating{
      position:fixed;
      right:16px;
      bottom:18px;
      z-index:20;
      border:none;
      border-radius:999px;
      padding:14px 18px;
      font-weight:900;
      cursor:pointer;
      color:#111;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      box-shadow: 0 18px 60px rgba(255,140,0,.30);
    }

    @media(min-width: 780px){
      .grid{ grid-template-columns: 1fr 1fr; }
      .fieldGrid{ grid-template-columns: 1fr 1fr; }
      .split2{ grid-template-columns: 1fr 1fr; }
      .hero h2{ font-size:44px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="topbar">
      <div class="brand">
        <div class="logo" title="Logo">
          <img src="logo.png" alt="Logo Espetinho Sousa" onerror="this.style.display='none';" />
        </div>
        <div class="title">
          <h1>Espetinho Sousa</h1>
          <p>Fogo, sabor e capricho • Delivery</p>
        </div>
      </div>
      <button class="btn ghost" onclick="scrollToId('finalizar')">Finalizar</button>
    </header>

    <div class="hero">
      <h2>O melhor espeto da região!</h2>
      <p>Feito na brasa, sabor de verdade. Monte seu pedido e pague pelo site.</p>

      <div class="hoursWrap" id="horarios">
        <div class="hoursTop">
          <div class="badge">
            <span class="statusDot"></span>
            <b>Horário de funcionamento</b>
          </div>
          <div class="badge">
            Região: <b>Capão Redondo • Zona Sul</b>
          </div>
        </div>
        <div class="hoursList">
          <div><span>Quinta a Sábado:</span> 19h às 01h</div>
          <div><span>Domingo:</span> 14h às 18h</div>
        </div>
        <div class="noteWarn">
          <b>Modo teste:</b> pagamento liberado sem bloqueio de horário (você pediu pra testar).
        </div>
      </div>
    </div>

    <section>
      <h3 class="secTitle">Espetos</h3>
      <p class="secSub">Escolha seus espetos e ajuste a quantidade.</p>
      <div class="grid" id="listEspetos"></div>
    </section>

    <section>
      <h3 class="secTitle">Combos</h3>
      <p class="secSub">Nos combos, informe na observação qual espeto deseja quando aplicável.</p>
      <div class="card" style="margin-top:12px;">
        <b>Exemplo:</b> “Combo Prata: quero espeto de carne”.
      </div>
      <div class="grid" id="listCombos"></div>
    </section>

    <section>
      <h3 class="secTitle">Acompanhamentos</h3>
      <p class="secSub">Adicione acompanhamentos ao seu pedido.</p>
      <div class="grid" id="listAcomp"></div>
    </section>

    <section>
      <h3 class="secTitle">Bebidas</h3>
      <p class="secSub">Refrigerantes 350ml e sucos naturais.</p>
      <div class="grid" id="listBebidas"></div>
    </section>

    <section id="finalizar">
      <h3 class="secTitle">Finalizar</h3>
      <p class="secSub">Preencha seus dados. O frete aparece automaticamente após o CEP válido.</p>

      <div class="checkout">
        <div class="fieldGrid">
          <div>
            <label>Seu nome (obrigatório)</label>
            <input id="nome" placeholder="Ex: Ingrid" />
          </div>
          <div>
            <label>Telefone (obrigatório)</label>
            <input id="telefone" placeholder="Ex: (11) 99999-9999" inputmode="tel" />
          </div>
        </div>

        <div class="fieldGrid">
          <div>
            <label>CEP (obrigatório)</label>
            <input id="cep" placeholder="Ex: 00000-000" inputmode="numeric" />
          </div>
          <div>
            <label>Rua</label>
            <input id="rua" placeholder="Será preenchido pelo CEP" />
          </div>
        </div>

        <div class="fieldGrid">
          <div>
            <label>Número (obrigatório)</label>
            <input id="numero" placeholder="Ex: 123" inputmode="numeric" />
          </div>
          <div>
            <label>Complemento</label>
            <input id="complemento" placeholder="Ex: Apto 12 / Casa 2" />
          </div>
        </div>

        <div class="fieldGrid">
          <div>
            <label>Bairro</label>
            <input id="bairro" placeholder="Será preenchido pelo CEP" />
          </div>
          <div>
            <label>Cidade/UF</label>
            <input id="cidadeUf" placeholder="Será preenchido pelo CEP" />
          </div>
        </div>

        <!-- DELIVERY (aparece só com CEP válido) -->
        <div class="deliveryBox" id="deliveryBox">
          <b style="color:var(--text);">Delivery</b>
          <div style="margin-top:6px;color:var(--muted);font-size:12.8px;line-height:1.35;">
            O frete é calculado automaticamente pelo bairro retornado no CEP (ou pelo bairro que você digitar).
          </div>

          <div class="totals">
            <div class="pill">
              <small>Subtotal</small>
              <b id="subtotalTxt">R$ 0,00</b>
            </div>
            <div class="pill">
              <small>Entrega</small>
              <b id="freteTxt">R$ 0,00</b>
            </div>
            <div class="pill total">
              <small>Total</small>
              <b id="totalTxt">R$ 0,00</b>
            </div>
          </div>
        </div>

        <div class="payWrap">
          <label>Forma de pagamento (obrigatório)</label>
          <select id="pagamento">
            <option value="">Selecione...</option>
            <option value="PIX">PIX</option>
            <option value="CARTAO">Cartão (débito/crédito)</option>
          </select>

          <div class="cards" aria-label="Bandeiras aceitas">
            <span class="cardPill">VISA</span>
            <span class="cardPill">MASTER</span>
            <span class="cardPill">ELO</span>
            <span class="cardPill">HIPERCARD</span>
          </div>
        </div>

        <div style="margin-top:12px;">
          <label>Observações do pedido (obrigatório)</label>
          <textarea id="obsPedido" placeholder="Ex.: Combo Prata: quero espeto de carne."></textarea>
          <div style="margin-top:6px; color:var(--muted); font-size:12.5px; line-height:1.35;">
            Use este campo para escolhas do combo e preferências (ex.: “farofa sem calabresa”).
          </div>
        </div>

        <div class="actions">
          <button class="btn ghost" onclick="resetAll()">Limpar</button>
          <button class="btn ghost" onclick="scrollToId('avaliacoes')">Avaliar</button>
          <button class="btn" id="btnPagar" onclick="pagarMercadoPago()">Pagar com Mercado Pago</button>
        </div>

        <div style="margin-top:10px; color:var(--muted); font-size:12.5px; line-height:1.35;">
          Ao clicar em “Pagar com Mercado Pago”, você será redirecionado para uma página segura de pagamento.
        </div>
      </div>
    </section>

    <section id="avaliacoes">
      <h3 class="secTitle">Avaliações</h3>
      <p class="secSub">Deixe sua nota e comentário.</p>

      <div class="commentBox">
        <div class="split2">
          <div>
            <label>Seu nome</label>
            <input id="cNome" placeholder="Ex: Maria" />
          </div>
          <div>
            <label>Nota (1 a 5)</label>
            <select id="cNota">
              <option value="5">5 - Excelente</option>
              <option value="4">4 - Muito bom</option>
              <option value="3">3 - Bom</option>
              <option value="2">2 - Regular</option>
              <option value="1">1 - Ruim</option>
            </select>
          </div>
        </div>

        <div style="margin-top:10px;">
          <label>Comentário</label>
          <textarea id="cTexto" placeholder="Conte como foi sua experiência..."></textarea>
        </div>

        <div class="actions" style="margin-top:10px;">
          <button class="btn ghost" onclick="clearComments()">Apagar comentários</button>
          <button class="btn" onclick="addComment()">Enviar comentário</button>
        </div>

        <div id="commentsList" class="commentsList"></div>
        <p style="margin:10px 0 0; color:var(--muted); font-size:12.5px;">
          Esses comentários ficam salvos neste navegador/celular (não é um banco online).
        </p>
      </div>
    </section>

    <footer>
      <div class="footRow">
        <div>
          <b style="color:var(--text);">Espetinho Sousa</b><br/>
          <span>Capão Redondo • Zona Sul</span>
        </div>
        <div class="footLinks">
          <a class="footBtn" id="linkWhats" href="#" target="_blank" rel="noopener">WhatsApp</a>
          <a class="footBtn" id="linkInsta" href="#" target="_blank" rel="noopener">Instagram</a>
        </div>
      </div>
    </footer>
  </div>

  <button class="floating" onclick="scrollToId('finalizar')">Finalizar</button>

  <script>
    /**********************
     * CONFIGURAÇÕES
     **********************/
    // ✅ SUA URL DO BACKEND (já preenchida)
    const BACKEND_URL = "https://backend-mercadopago-zyg6.onrender.com";

    // ✅ Seu WhatsApp (somente números: 55 + DDD + número)
    const WHATSAPP_NUMBER = "5511968363952";

    // ✅ Instagram
    const INSTAGRAM_USER = "espetinhos.sousa";

    // ✅ Tabela de frete por bairro (edite como quiser)
    const FRETE_POR_BAIRRO = [
      { match: ["capão redondo", "capao redondo"], valor: 5.00 },
      { match: ["campo limpo"], valor: 6.00 },
      { match: ["jardim ângela", "jardim angela"], valor: 7.00 },
      { match: ["vila das belezas"], valor: 6.00 },
      { match: ["jardim são luís", "jardim sao luis"], valor: 7.00 },
    ];
    const FRETE_PADRAO = 8.00;

    // ✅ Produtos
    const ESPETOS = [
      { id:"carne",  nome:"Brasa Clássico (carne)", desc:"Espeto de carne.", preco: 10.00 },
      { id:"frango", nome:"Sabor do Fogo (frango)", desc:"Espeto de frango.", preco: 10.00 },
      { id:"ling",   nome:"Sabor Intenso (linguiça)", desc:"Espeto de linguiça.", preco: 10.00 },
      { id:"misto",  nome:"Espeto Supremo (misto)", desc:"Mais completo, ideal pra quem quer capricho.", preco: 12.00 },
    ];

    const COMBOS = [
      { id:"combo_bronze", nome:"Combo Bronze Raiz", desc:"Arroz tradicional + 1 espeto (carne, frango ou linguiça).", preco: 13.00 },
      { id:"combo_prata",  nome:"Combo Prata Sabor", desc:"Arroz tradicional + vinagrete da casa + 1 espeto (qualquer opção do cardápio).", preco: 16.00 },
      { id:"combo_ouro",   nome:"Combo Ouro na Brasa", desc:"Arroz tradicional + vinagrete da casa + farofa + 1 espeto (qualquer opção do cardápio).", preco: 20.00 },
    ];

    const ACOMP = [
      { id:"arroz", nome:"Arroz Tradicional", desc:"Arroz branco soltinho, temperado com alho e sal, preparado com carinho.", preco: 7.00 },
      { id:"vina",  nome:"Vinagrete da Casa", desc:"Vinagrete fresca com tomate, cebola e repolho, bem temperado.", preco: 7.00 },
      { id:"farofa",nome:"Farofa Caseira", desc:"Farofa bem douradinha, preparada com calabresa defumada e bacon.", preco: 4.00 },
      { id:"paoalho",nome:"Pão de Alho", desc:"Cremoso caseiro, feito com pão francês e ingredientes especiais.", preco: 8.00 },
      { id:"maio",  nome:"Maionese Especial", desc:"Maionese verde cremosa, perfeita para acompanhar seu pedido.", preco: 5.00 },
    ];

    const BEBIDAS = [
      { id:"coca", nome:"Coca-Cola 350ml", desc:"Geladinha.", preco: 6.00 },
      { id:"pepsi", nome:"Pepsi 350ml", desc:"Geladinha.", preco: 6.00 },
      { id:"guarana", nome:"Guaraná Antarctica 350ml", desc:"Geladinha.", preco: 6.00 },
      { id:"ituba", nome:"Itubaína 350ml", desc:"Geladinha.", preco: 6.00 },
      { id:"suco300_abacaxi", nome:"Suco natural 300ml (abacaxi com hortelã)", desc:"Feito na hora.", preco: 9.00 },
      { id:"suco300_maracuja", nome:"Suco natural 300ml (maracujá)", desc:"Feito na hora.", preco: 9.00 },
      { id:"suco300_laranja", nome:"Suco natural 300ml (laranja)", desc:"Feito na hora.", preco: 9.00 },
      { id:"suco300_goiaba", nome:"Suco natural 300ml (goiaba)", desc:"Feito na hora.", preco: 9.00 },
      { id:"suco500_abacaxi", nome:"Suco natural 500ml (abacaxi com hortelã)", desc:"Feito na hora.", preco: 13.00 },
      { id:"suco500_maracuja", nome:"Suco natural 500ml (maracujá)", desc:"Feito na hora.", preco: 13.00 },
      { id:"suco500_laranja", nome:"Suco natural 500ml (laranja)", desc:"Feito na hora.", preco: 13.00 },
      { id:"suco500_goiaba", nome:"Suco natural 500ml (goiaba)", desc:"Feito na hora.", preco: 13.00 },
    ];

    /**********************
     * ESTADO / HELPERS
     **********************/
    const money = v => (v||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
    const qty = {};
    const ALL = [...ESPETOS, ...COMBOS, ...ACOMP, ...BEBIDAS];
    ALL.forEach(i => qty[i.id] = 0);

    let freteAtual = 0;
    let cepValido = false;

    function scrollToId(id){
      const el = document.getElementById(id);
      if(!el) return;
      el.scrollIntoView({behavior:"smooth", block:"start"});
    }

    function renderCard(item){
      const q = qty[item.id] || 0;
      const mini = q * item.preco;
      return `
        <div class="card" data-id="${item.id}">
          <div class="rowTop">
            <div style="min-width:0;">
              <p class="itemName">${item.nome}</p>
              <p class="itemDesc">${item.desc}</p>
            </div>
            <div class="price">${money(item.preco)}</div>
          </div>

          <div class="qtyRow">
            <div class="qtyCtrl">
              <button class="qbtn" onclick="dec('${item.id}')">−</button>
              <div class="qval" id="q_${item.id}">${q}</div>
              <button class="qbtn" onclick="inc('${item.id}')">+</button>
            </div>
            <div class="miniTotal">
              <div>Parcial</div>
              <b id="m_${item.id}">${money(mini)}</b>
            </div>
          </div>
        </div>
      `;
    }

    function renderAll(){
      document.getElementById("listEspetos").innerHTML = ESPETOS.map(renderCard).join("");
      document.getElementById("listCombos").innerHTML  = COMBOS.map(renderCard).join("");
      document.getElementById("listAcomp").innerHTML   = ACOMP.map(renderCard).join("");
      document.getElementById("listBebidas").innerHTML = BEBIDAS.map(renderCard).join("");
      updateTotals();
    }

    function inc(id){
      qty[id] = (qty[id]||0) + 1;
      updateItem(id);
    }
    function dec(id){
      qty[id] = Math.max(0, (qty[id]||0) - 1);
      updateItem(id);
    }
    function updateItem(id){
      const item = ALL.find(x => x.id === id);
      if(!item) return;
      const qEl = document.getElementById("q_"+id);
      const mEl = document.getElementById("m_"+id);
      if(qEl) qEl.textContent = qty[id];
      if(mEl) mEl.textContent = money((qty[id]||0)*item.preco);
      updateTotals();
    }

    function calcSubtotal(){
      let s = 0;
      for(const it of ALL){
        s += (qty[it.id]||0) * it.preco;
      }
      return s;
    }

    function updateTotals(){
      const subtotal = calcSubtotal();
      document.getElementById("subtotalTxt").textContent = money(subtotal);
      document.getElementById("freteTxt").textContent = money(freteAtual);
      document.getElementById("totalTxt").textContent = money(subtotal + freteAtual);

      const dbox = document.getElementById("deliveryBox");
      if(cepValido){
        dbox.classList.add("show");
      }else{
        dbox.classList.remove("show");
      }

      updatePayButtonState();
    }

    /**********************
     * CEP + FRETE
     **********************/
    function onlyDigits(s){ return (s||"").replace(/\D+/g,""); }

    async function buscarCep(){
      const cep = onlyDigits(document.getElementById("cep").value);
      if(cep.length !== 8){
        cepValido = false;
        freteAtual = 0;
        updateTotals();
        return;
      }

      try{
        const res = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
        const data = await res.json();
        if(data.erro) throw new Error("CEP inválido");

        document.getElementById("rua").value = data.logradouro || "";
        document.getElementById("bairro").value = data.bairro || "";
        document.getElementById("cidadeUf").value = `${data.localidade || ""}/${data.uf || ""}`.replace(/^\/|\/$/g,"");

        freteAtual = calcularFretePorBairro(data.bairro || "");
        cepValido = true;
        updateTotals();
      }catch(e){
        cepValido = false;
        freteAtual = 0;
        updateTotals();
      }
    }

    function calcularFretePorBairro(bairro){
      const b = (bairro||"").toLowerCase().trim();
      if(!b) return FRETE_PADRAO;

      for(const regra of FRETE_POR_BAIRRO){
        for(const termo of regra.match){
          if(b.includes((termo||"").toLowerCase())){
            return Number(regra.valor || 0);
          }
        }
      }
      return FRETE_PADRAO;
    }

    /**********************
     * LINKS
     **********************/
    function initLinks(){
      const w = document.getElementById("linkWhats");
      const i = document.getElementById("linkInsta");
      w.href = `https://wa.me/${WHATSAPP_NUMBER}`;
      i.href = `https://instagram.com/${INSTAGRAM_USER}`;
    }

    /**********************
     * PAGAMENTO (SEM BLOQUEIO - TESTE)
     **********************/
    function validateCheckout(){
      const faltando = [];
      const nome = document.getElementById("nome").value.trim();
      const tel = document.getElementById("telefone").value.trim();
      const cep = onlyDigits(document.getElementById("cep").value);
      const numero = document.getElementById("numero").value.trim();
      const pagamento = document.getElementById("pagamento").value;
      const obs = document.getElementById("obsPedido").value.trim();

      if(!nome) faltando.push("Nome");
      if(!tel) faltando.push("Telefone");
      if(cep.length !== 8) faltando.push("CEP");
      if(!numero) faltando.push("Número");
      if(!pagamento) faltando.push("Forma de pagamento");
      if(!obs) faltando.push("Observações do pedido");
      if(calcSubtotal() <= 0) faltando.push("Itens do pedido");

      return { ok: faltando.length === 0, faltando };
    }

    function updatePayButtonState(){
      const btn = document.getElementById("btnPagar");
      const subtotal = calcSubtotal();
      // ✅ sem bloqueio de horário
      btn.disabled = !(subtotal > 0);
    }

    async function pagarMercadoPago(){
      if(!BACKEND_URL){
        alert("Falta configurar a URL do backend no código (BACKEND_URL).");
        return;
      }

      const v = validateCheckout();
      if(!v.ok){
        alert("Campos obrigatórios:\n- " + v.faltando.join("\n- "));
        return;
      }

      const items = ALL
        .filter(i => (qty[i.id]||0) > 0)
        .map(i => ({
          id: i.id,
          title: i.nome,
          description: i.desc,
          quantity: qty[i.id],
          unit_price: i.preco
        }));

      const payload = {
        customer: {
          name: document.getElementById("nome").value.trim(),
          phone: document.getElementById("telefone").value.trim(),
        },
        address: {
          cep: document.getElementById("cep").value.trim(),
          street: document.getElementById("rua").value.trim(),
          number: document.getElementById("numero").value.trim(),
          complement: document.getElementById("complemento").value.trim(),
          neighborhood: document.getElementById("bairro").value.trim(),
          cityUf: document.getElementById("cidadeUf").value.trim(),
        },
        payment_method: document.getElementById("pagamento").value, // PIX ou CARTAO
        notes: document.getElementById("obsPedido").value.trim(),
        items,
        shipping: { amount: freteAtual },
        totals: {
          subtotal: calcSubtotal(),
          total: calcSubtotal() + freteAtual
        }
      };

      try{
        const btn = document.getElementById("btnPagar");
        btn.disabled = true;
        btn.textContent = "Abrindo pagamento...";

        // Endpoint esperado: /create-preference => { init_point }
        const res = await fetch(`${BACKEND_URL}/create-preference`, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });

        if(!res.ok){
          const t = await res.text().catch(()=> "");
          throw new Error("Backend respondeu erro. " + t);
        }

        const data = await res.json();
        if(!data || !data.init_point){
          throw new Error("Resposta do backend sem init_point.");
        }

        window.location.href = data.init_point;
      }catch(e){
        alert("Não foi possível abrir o pagamento agora.\n\nDetalhe: " + (e.message || e));
      }finally{
        const btn = document.getElementById("btnPagar");
        btn.textContent = "Pagar com Mercado Pago";
        updatePayButtonState();
      }
    }

    /**********************
     * RESET
     **********************/
    function resetAll(){
      for(const k in qty) qty[k] = 0;
      ["nome","telefone","cep","rua","numero","complemento","bairro","cidadeUf","obsPedido"].forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.value = "";
      });
      document.getElementById("pagamento").value = "";
      freteAtual = 0;
      cepValido = false;
      renderAll();
    }

    /**********************
     * COMENTÁRIOS
     **********************/
    const COMMENTS_KEY = "espetinho_sousa_comments_v1";
    function loadComments(){
      try{ return JSON.parse(localStorage.getItem(COMMENTS_KEY) || "[]"); }
      catch(e){ return []; }
    }
    function saveComments(list){
      localStorage.setItem(COMMENTS_KEY, JSON.stringify(list));
    }
    function renderComments(){
      const list = loadComments();
      const box = document.getElementById("commentsList");
      box.innerHTML = "";
      if(list.length === 0){
        box.innerHTML = `<div style="color:var(--muted); font-size:13px;">Sem avaliações ainda.</div>`;
        return;
      }
      for(const c of list.slice().reverse()){
        const stars = "★".repeat(Number(c.rating||5)) + "☆".repeat(5-Number(c.rating||5));
        const el = document.createElement("div");
        el.className = "commentItem";
        el.innerHTML = `
          <div class="top">
            <span><b style="color:var(--text);">${escapeHtml(c.name||"Cliente")}</b> • ${escapeHtml(c.date||"")}</span>
            <span class="stars">${stars}</span>
          </div>
          <p>${escapeHtml(c.text||"")}</p>
        `;
        box.appendChild(el);
      }
    }
    function addComment(){
      const name = document.getElementById("cNome").value.trim() || "Cliente";
      const rating = Number(document.getElementById("cNota").value || 5);
      const text = document.getElementById("cTexto").value.trim();
      if(!text){
        alert("Escreva um comentário antes de enviar.");
        return;
      }
      const list = loadComments();
      list.push({
        name,
        rating,
        text,
        date: new Date().toLocaleString("pt-BR")
      });
      saveComments(list);
      document.getElementById("cTexto").value = "";
      renderComments();
    }
    function clearComments(){
      if(!confirm("Apagar todos os comentários deste navegador/celular?")) return;
      localStorage.removeItem(COMMENTS_KEY);
      renderComments();
    }
    function escapeHtml(str){
      return (str||"").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    /**********************
     * CEP: máscara + eventos
     **********************/
    function maskCep(){
      const el = document.getElementById("cep");
      const d = onlyDigits(el.value).slice(0,8);
      el.value = d.length > 5 ? (d.slice(0,5) + "-" + d.slice(5)) : d;
    }

    document.addEventListener("input", (ev)=>{
      if(ev.target && ev.target.id === "cep"){
        maskCep();
      }
    });

    document.addEventListener("blur", (ev)=>{
      if(ev.target && ev.target.id === "cep"){
        buscarCep();
      }
      if(ev.target && ev.target.id === "bairro"){
        freteAtual = calcularFretePorBairro(document.getElementById("bairro").value || "");
        if(onlyDigits(document.getElementById("cep").value).length === 8){
          cepValido = true;
        }
        updateTotals();
      }
    }, true);

    renderAll();
    renderComments();
    initLinks();
    updatePayButtonState();
  </script>
</body>
</html>
